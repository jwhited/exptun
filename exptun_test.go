package main

import (
	"bytes"
	"encoding/hex"
	"github.com/google/gopacket"
	"github.com/google/gopacket/layers"
	"net/netip"
	"os"
	"reflect"
	"testing"

	"github.com/google/gopacket/pcapgo"
)

func Test_checksum(t *testing.T) {
	testA, _ := hex.DecodeString("4500003c49db400040060000ac10ff02ac10ff01")
	testB, _ := hex.DecodeString("4500003c65e5400040060000ac10ff02ac10ff01")
	type args struct {
		b []byte
	}
	tests := []struct {
		name string
		args args
		want uint16
	}{
		{
			"test A",
			args{
				testA,
			},
			0x9abb,
		},
		{
			"test B",
			args{
				testB,
			},
			0x7eb1,
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			if got := checksum(tt.args.b); got != tt.want {
				t.Errorf("checksum() = %x, want %x", got, tt.want)
			}
		})
	}
}

func Test_packetHandler_handle(t *testing.T) {
	in, _ := hex.DecodeString("45000b841728400040060000ac10ff02ac10ff01e43814515c59a1d997149596801801f6000000000101080af2f196def2f196dcffeffdcad64822923e610ca59dc5c6d9917cac4ed11917286ba404b41e53aca070a5f32a896587e8b9e33ae1cfbe96f3d68b72240ef23368bed07c17313c9753854ea2dd48be60b93c3bb00a51cc5992c650d0cb96abe45ab66293cf7fead73b8dcb15cab2829373852233e708592949be6994fb8c99439d1883c66428fc7ddbbc785fe71264e9441e1c906d4b195b66fc2b9bd941a7de68eb87c2f354c0c8f2da545829c14ca9e416e7f4e45c9bdd539ed00882f89d76357b94f1d3f26f3e89a6290f0e8eba4d530a5624d460c14da0cb90f45762d2f722fcfe8cff337303d7656e37c1dba1452e772a6f895b11df9a8a09de9fc08141e66c67ef26662cc749b6a24338184b6c1915863267337979a9392863b26ee1fe2f855b88d54cdb1d38e97aad27a3fa3ced76dbeb8c1629bbf4d84fbfac8e96a41e7e384b2f0dc49470b9f714ecab5ea81ce670f472a5c0b33cf78e6839ece37b0337e3cff849815ee915b60a00e3428fe6767979daaaa44a2d13ef843a5b08be302cfbfda6fe1d47ffdaec4739a6793f3405e98313dd985fed86b2d0f91ccb028260c58c2802e001581ad874cdc9fa92f4a5a5bfa935dd41b0da4263b771d51001562740d03b6fca8e33c0ca39ea2a9bdd871652e5294b5ad082081b5430fc1c3432f2361fffbdb6ec70a90f2daf2ffd79eb3f3a18db34744f5480273b691c6d92b0affe42c6c44982d2ef2c0d26f60273e8a55b3785abfb015c1e8e289b4e199ec9dad0efe6ff98b3fb86ba058f1fb8ff2b3fb87352144992f1c5424f2007e4bcd17649ec3b673824c0c15bf479d1638dc5898c265c5ee9db270463ff521d942825378d0188c6b6b59bdd51b75f42d53fca02a0ae6569cf8b97411408e97b7789b97970c5391ab6b4ddf1b7d039690c5291db50a83c4b57d7bd52edda4d45f0b93437bb6e1d6b42e4198d0e8024eb76c695cda234261676f40e9df139b9b5ee1f31678264f8c934c6e8276466c8810272af525eaf9214014ced006b9f792690eb3cc914ba60026906d851be070924e601b9675955a50658d8005fcd9f11d0fad64f7afc9d6b5bfb7a1cc8883de73a41394e49a33d1c6d31aa997f710949c533112730d0b32897a6ab914ae3b3ce6067e082bdf1d2b2e30a0cf7ac79f4c152ad46be8341575abd57a6ca6b1c633138d61b5d1eb660fc187a2029441337b8dd6519448ea597556aed496f6cdd26346db3b04f5f12c51a5dcad4ca2a97d07ad6413af61d2b3b709f34238c29c630645546b90044f29c48efdde1fa7ddc294e0b0ee83fa2f8490ea56a8768431917b86438e7d7434b0545b3fd2f187c6838eccaa112e43cadc6cd88368083a36fdb7bf811a548d23c328044275ca485741eafb58859ea43fac0f3fe63fc4fe2d78aeedc02cc838a80a102c4c36ce412cccf444dc599700ca009a9e2a8cdaf3ca91038b64869b60f09fac69279376f4c31c13c497eff1bcaf9c813356104f70687d38cea19c68e31a2a2d67ed0fc1db1a7902d69fc7eb79d332934728425a45c6ec20aa9ccd860323ddf26013f061bf29c193c3fec503b5cdd6b4639990b2303659adf87845b401d1aad1731be27998d0b65ff442852ba19872c0aaa363c58ded3da3dd1ac73428e467d190d578aa845779c25bc5439a0888fa7b0c00b34681c62341cd55eda87b77ae54b4028a179fba6a11ee49b7b066106328cf2c15186c676a09807660592bc83bb46acc501327da8348f25f35c611bd544790eaaa2ab3b206c63f6717658935dc3c0b937d9df6df6c554a21ddc85fee2ec8901a1bfb96f6c311dde6536c001bd8660dd9a7c97c876a3075722b364605cf8aac1c1b1696420e54954c37ca82fd429932cd1de13ce9311d0d98c3a8d33806069fec2e81c4aeb11694208d1084dfb471a740e6681e83ea7219bd83b2a0429e170b0311e0c9dc081a6c74596c4b663f759d9fa867c60d432263eded9239482d04e622dd228cfc90112fa0777d834fbcef1afd4dab5eb0dda45d90b05b5538a6acfa6c89c8cad23d565720185fb7098486421f5a0b965f926d7ad9c2ce1347306b82db1420b864ca3c2a44d8d67d5658d6f17551c494fe498bf8fe061fb312e7fab109c1fe3477340c0c4a8e916ae4ff158b7fa6de8b2eb09315fcb61dc741ca00b115759094f607391b48ef8a975e603db399b207bdd511adb8a321fb20ecf430c5211651e787c6788d861afac615cff0a271643ab5e676e2f395d29b01dfcd7b3cab9d35a65aad8a5149e6cf9946286f2dbf71543ca71c17339809309a10f1995c3e39dc66fb08cb9271b9de1587fbe8452cea64bb737c3149ad4c4bd78091cf6b7d15365a6f756e32af889a6e649461073217c59778365aecb46b495fad0088058e644cc857541f6dc15f270386e032f386e5404addc250e75a2632b89178179fcc342fc0b0341256d59623982aa274e7bc20a4079225befdef7755facaf6bff22208f3b14865f7351d798fde7ef8f4d3579a48241d5bf812d9342ee5968b84abbf1d92326639d847fec05fc3020892edd82a8268a166d424c864a2164dfcc88bb9c3647a652a2ee06d4cbe0e4509154471735d599cd41bc6114c5d9a76988ecd66a2b024c66a276c7f89d631bf0a6d779285660d99d96b0d824f1ca854135f069b295551ab0692b73793fbef98da83a67b90cc002441d91542b3121fd3e336f2b42a1fb93b0a8520fc837379a635ab53d873c75d3070d8a367d0b950fdc38b57db3e50d3511384fa4c23bb8ef0a9560a84e7cce35837873eca644caa37fb038774af5baf4090a126f6d6267891682630ddb8ae56e339be04736e20882246c98cafdf583cc3f2fb49c80c1d695a01dd3185e1768efb902598b6657c1ec1b2fdd8e6dc49dd8e18b7afab0ba9cc9db5876c3c13491193f89cf71c338b67f26a2675b9c0cd6968c4d1c54383e7e64b8126500dee709428e52041b94c0f156c53a0456c2bed405926995f0afc692b339df8c3ee0356eabfa9e97fdd425c8ad305d70c42ad84803aa44c7e95f0042d61c19845d610f270c6eba00def209159f3982e9c9a9550b33d35651b4c7f44c9224128e89b26865a050197a86d32214cbab9b560d726feffbf4a5bf483deef9df510b77fdc7fbae9a29e6376029d3fcc82200b2c4931c09d186d651a74a90ad177e3b65e7b23a0a330fe07f7745283abb9b450a94f4e819cf7dd1ec75498697eb8c4a2388116be8f19e4b9f5c0dfded82bfa94d0275e9615b716f4173c1ef53980b991d295772dd9319fc5b07fb1ca7e1c0a44ab1eb458cc0c9381e9cd8d35f107fd9d9e92b146cb0aa272558572c629f1b6adf0683d5196dd2626b2ac9ae97940afec7fa1d909e098fe7097df97c31234fe1468b4c51ed4ead39f7419d614a425a2d9a5664ad9710a829bb1eb0cf1b49a22f0006ebe8e57bd6d78bb617bc8eee8b2e348b61e1a6431c6acccbaaf1b5d4630b3f63a00637e08704ca36e62ee2cbe8582561c40b57259ba1a687a0484127957735c5c5dfaf8b3dc0d1ca1f9ee2c1b1c036df5180ebdcf78a690c779cdefe60ee2e5824bf722f79321bc4ca90dd7ca0e94c80d8694ae4a7badea71c254261709b1a047a512274ed9f9b211001202b554e227862ebc78bfcefe5e2a70542a2020ec38c7ca7b7e6ef3a81358e3d6fc3a55654d3bfe77c396ade5c948f3846a3f5197fcc735f9ebde622843810b8d909cfd5693513b5cd13442f7a007ad3255580e8df0d8bb5809618bba3ba2be43a37b6522b99de988b5193d36922a0a71caf6e149f010327c6f0dcc8fc60308b7c08bfea7f7b56d70a30917f10406e7319f689090f1b7a55f939cf147897cf68ce9aebfe657febdbf71620eac8b6d65daede6d4215ca73b7d114f83a6da52fc7ae393324d535cfd37364affd920d5dadc7cfec9f465975a72ec80344eeb7e8a11a663c1623cc589ff7a4e2a6d66f88f69e37beb0bd732756bd73a86264147caa52b6f54ad162084d2f79c73b9283f12aa832367e1e2316b6d02c44b148e14c71a939e39f1322c685a89597b44be386fa12c772fa190aad111ba18914b6fc38db29d472ce2361e0bb")
	out0, _ := hex.DecodeString("450005dc172840004006c7ceac10ff02ac10ff01e43814515c59a1d997149596801801f6554b00000101080af2f196def2f196dcffeffdcad64822923e610ca59dc5c6d9917cac4ed11917286ba404b41e53aca070a5f32a896587e8b9e33ae1cfbe96f3d68b72240ef23368bed07c17313c9753854ea2dd48be60b93c3bb00a51cc5992c650d0cb96abe45ab66293cf7fead73b8dcb15cab2829373852233e708592949be6994fb8c99439d1883c66428fc7ddbbc785fe71264e9441e1c906d4b195b66fc2b9bd941a7de68eb87c2f354c0c8f2da545829c14ca9e416e7f4e45c9bdd539ed00882f89d76357b94f1d3f26f3e89a6290f0e8eba4d530a5624d460c14da0cb90f45762d2f722fcfe8cff337303d7656e37c1dba1452e772a6f895b11df9a8a09de9fc08141e66c67ef26662cc749b6a24338184b6c1915863267337979a9392863b26ee1fe2f855b88d54cdb1d38e97aad27a3fa3ced76dbeb8c1629bbf4d84fbfac8e96a41e7e384b2f0dc49470b9f714ecab5ea81ce670f472a5c0b33cf78e6839ece37b0337e3cff849815ee915b60a00e3428fe6767979daaaa44a2d13ef843a5b08be302cfbfda6fe1d47ffdaec4739a6793f3405e98313dd985fed86b2d0f91ccb028260c58c2802e001581ad874cdc9fa92f4a5a5bfa935dd41b0da4263b771d51001562740d03b6fca8e33c0ca39ea2a9bdd871652e5294b5ad082081b5430fc1c3432f2361fffbdb6ec70a90f2daf2ffd79eb3f3a18db34744f5480273b691c6d92b0affe42c6c44982d2ef2c0d26f60273e8a55b3785abfb015c1e8e289b4e199ec9dad0efe6ff98b3fb86ba058f1fb8ff2b3fb87352144992f1c5424f2007e4bcd17649ec3b673824c0c15bf479d1638dc5898c265c5ee9db270463ff521d942825378d0188c6b6b59bdd51b75f42d53fca02a0ae6569cf8b97411408e97b7789b97970c5391ab6b4ddf1b7d039690c5291db50a83c4b57d7bd52edda4d45f0b93437bb6e1d6b42e4198d0e8024eb76c695cda234261676f40e9df139b9b5ee1f31678264f8c934c6e8276466c8810272af525eaf9214014ced006b9f792690eb3cc914ba60026906d851be070924e601b9675955a50658d8005fcd9f11d0fad64f7afc9d6b5bfb7a1cc8883de73a41394e49a33d1c6d31aa997f710949c533112730d0b32897a6ab914ae3b3ce6067e082bdf1d2b2e30a0cf7ac79f4c152ad46be8341575abd57a6ca6b1c633138d61b5d1eb660fc187a2029441337b8dd6519448ea597556aed496f6cdd26346db3b04f5f12c51a5dcad4ca2a97d07ad6413af61d2b3b709f34238c29c630645546b90044f29c48efdde1fa7ddc294e0b0ee83fa2f8490ea56a8768431917b86438e7d7434b0545b3fd2f187c6838eccaa112e43cadc6cd88368083a36fdb7bf811a548d23c328044275ca485741eafb58859ea43fac0f3fe63fc4fe2d78aeedc02cc838a80a102c4c36ce412cccf444dc599700ca009a9e2a8cdaf3ca91038b64869b60f09fac69279376f4c31c13c497eff1bcaf9c813356104f70687d38cea19c68e31a2a2d67ed0fc1db1a7902d69fc7eb79d332934728425a45c6ec20aa9ccd860323ddf26013f061bf29c193c3fec503b5cdd6b4639990b2303659adf87845b401d1aad1731be27998d0b65ff442852ba19872c0aaa363c58ded3da3dd1ac73428e467d190d578aa845779c25bc5439a0888fa7b0c00b34681c62341cd55eda87b77ae54b4028a179fba6a11ee49b7b066106328cf2c15186c676a09807660592bc83bb46acc501327da8348f25f35c611bd544790eaaa2ab3b206c63f6717658935dc3c0b937d9df6df6c554a21ddc85fee2ec8901a1bfb96f6c311dde6536c001bd8660dd9a7c97c876a3075722b364605cf8aac1c1b1696420e54954c37ca82fd429932cd1de13ce9311d0d98c3a8d33806069fec2e81c4aeb11694208d1084dfb471a740e6681e83ea7219bd83b2a0429e170b0311e0c9dc081a6c74596c4b663f759d9fa867c60d432263eded9239482d04e622dd228cfc90112fa0777d834fbcef1afd4dab5eb0dda45d90b05b5538a6acfa6c89c8cad23d565720185")
	out1, _ := hex.DecodeString("450005dc172840004006c7ceac10ff02ac10ff01e43814515c59a78197149596801801f6874100000101080af2f196def2f196dcfb7098486421f5a0b965f926d7ad9c2ce1347306b82db1420b864ca3c2a44d8d67d5658d6f17551c494fe498bf8fe061fb312e7fab109c1fe3477340c0c4a8e916ae4ff158b7fa6de8b2eb09315fcb61dc741ca00b115759094f607391b48ef8a975e603db399b207bdd511adb8a321fb20ecf430c5211651e787c6788d861afac615cff0a271643ab5e676e2f395d29b01dfcd7b3cab9d35a65aad8a5149e6cf9946286f2dbf71543ca71c17339809309a10f1995c3e39dc66fb08cb9271b9de1587fbe8452cea64bb737c3149ad4c4bd78091cf6b7d15365a6f756e32af889a6e649461073217c59778365aecb46b495fad0088058e644cc857541f6dc15f270386e032f386e5404addc250e75a2632b89178179fcc342fc0b0341256d59623982aa274e7bc20a4079225befdef7755facaf6bff22208f3b14865f7351d798fde7ef8f4d3579a48241d5bf812d9342ee5968b84abbf1d92326639d847fec05fc3020892edd82a8268a166d424c864a2164dfcc88bb9c3647a652a2ee06d4cbe0e4509154471735d599cd41bc6114c5d9a76988ecd66a2b024c66a276c7f89d631bf0a6d779285660d99d96b0d824f1ca854135f069b295551ab0692b73793fbef98da83a67b90cc002441d91542b3121fd3e336f2b42a1fb93b0a8520fc837379a635ab53d873c75d3070d8a367d0b950fdc38b57db3e50d3511384fa4c23bb8ef0a9560a84e7cce35837873eca644caa37fb038774af5baf4090a126f6d6267891682630ddb8ae56e339be04736e20882246c98cafdf583cc3f2fb49c80c1d695a01dd3185e1768efb902598b6657c1ec1b2fdd8e6dc49dd8e18b7afab0ba9cc9db5876c3c13491193f89cf71c338b67f26a2675b9c0cd6968c4d1c54383e7e64b8126500dee709428e52041b94c0f156c53a0456c2bed405926995f0afc692b339df8c3ee0356eabfa9e97fdd425c8ad305d70c42ad84803aa44c7e95f0042d61c19845d610f270c6eba00def209159f3982e9c9a9550b33d35651b4c7f44c9224128e89b26865a050197a86d32214cbab9b560d726feffbf4a5bf483deef9df510b77fdc7fbae9a29e6376029d3fcc82200b2c4931c09d186d651a74a90ad177e3b65e7b23a0a330fe07f7745283abb9b450a94f4e819cf7dd1ec75498697eb8c4a2388116be8f19e4b9f5c0dfded82bfa94d0275e9615b716f4173c1ef53980b991d295772dd9319fc5b07fb1ca7e1c0a44ab1eb458cc0c9381e9cd8d35f107fd9d9e92b146cb0aa272558572c629f1b6adf0683d5196dd2626b2ac9ae97940afec7fa1d909e098fe7097df97c31234fe1468b4c51ed4ead39f7419d614a425a2d9a5664ad9710a829bb1eb0cf1b49a22f0006ebe8e57bd6d78bb617bc8eee8b2e348b61e1a6431c6acccbaaf1b5d4630b3f63a00637e08704ca36e62ee2cbe8582561c40b57259ba1a687a0484127957735c5c5dfaf8b3dc0d1ca1f9ee2c1b1c036df5180ebdcf78a690c779cdefe60ee2e5824bf722f79321bc4ca90dd7ca0e94c80d8694ae4a7badea71c254261709b1a047a512274ed9f9b211001202b554e227862ebc78bfcefe5e2a70542a2020ec38c7ca7b7e6ef3a81358e3d6fc3a55654d3bfe77c396ade5c948f3846a3f5197fcc735f9ebde622843810b8d909cfd5693513b5cd13442f7a007ad3255580e8df0d8bb5809618bba3ba2be43a37b6522b99de988b5193d36922a0a71caf6e149f010327c6f0dcc8fc60308b7c08bfea7f7b56d70a30917f10406e7319f689090f1b7a55f939cf147897cf68ce9aebfe657febdbf71620eac8b6d65daede6d4215ca73b7d114f83a6da52fc7ae393324d535cfd37364affd920d5dadc7cfec9f465975a72ec80344eeb7e8a11a663c1623cc589ff7a4e2a6d66f88f69e37beb0bd732756bd73a86264147caa52b6f54ad162084d2f79c73b9283f12aa832367e1e2316b6d02c44b148e14c71a939e39f1322c685a89597b44be386fa12c772fa190aad111ba18914b6fc38db29d472ce2361e0bb")

	f, err := os.Create("handle.pcapng")
	if err != nil {
		t.Fatalf("error creating pcap: %v", err)
	}
	defer f.Close()

	w, err := pcapgo.NewNgWriter(f, layers.LinkTypeIPv4)
	if err != nil {
		t.Fatalf("error constructing writer: %v", err)
	}
	defer w.Flush()

	for i, b := range [][]byte{in, out0, out1} {
		err = w.WritePacket(gopacket.CaptureInfo{
			CaptureLength: len(b),
			Length:        len(b),
		}, b)
		if err != nil {
			t.Fatalf("error writing data for packet %d: %v", i, err)
		}
	}

	type fields struct {
		reader   *bytes.Reader
		tunAddr  netip.Prefix
		tunRoute netip.Prefix
		mode     tsoMode
	}
	type args struct {
		in  []byte
		out [][]byte
	}
	tests := []struct {
		name   string
		fields fields
		args   args
		want   []int
		want1  bool
	}{
		// TODO: Add test cases.
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			p := &packetHandler{
				reader:   tt.fields.reader,
				tunAddr:  tt.fields.tunAddr,
				tunRoute: tt.fields.tunRoute,
				mode:     tt.fields.mode,
			}
			got, got1 := p.handle(tt.args.in, tt.args.out)
			if !reflect.DeepEqual(got, tt.want) {
				t.Errorf("handle() got = %v, want %v", got, tt.want)
			}
			if got1 != tt.want1 {
				t.Errorf("handle() got1 = %v, want %v", got1, tt.want1)
			}
		})
	}
}
