package main

import (
	"bytes"
	"encoding/hex"
	"github.com/google/gopacket"
	"github.com/google/gopacket/layers"
	"net/netip"
	"os"
	"reflect"
	"testing"

	"github.com/google/gopacket/pcapgo"
)

func Test_checksum(t *testing.T) {
	testA, _ := hex.DecodeString("4500003c49db400040060000ac10ff02ac10ff01")
	testB, _ := hex.DecodeString("4500003c65e5400040060000ac10ff02ac10ff01")
	type args struct {
		b []byte
	}
	tests := []struct {
		name string
		args args
		want uint16
	}{
		{
			"test A",
			args{
				testA,
			},
			0x9abb,
		},
		{
			"test B",
			args{
				testB,
			},
			0x7eb1,
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			if got := checksum(tt.args.b); got != tt.want {
				t.Errorf("checksum() = %x, want %x", got, tt.want)
			}
		})
	}
}

func Test_packetHandler_handle(t *testing.T) {
	in, _ := hex.DecodeString("45000b8436d4400040060000ac10ff02ac10ff01a678145192d5000019e81700801801f6619c00000101080ac769e7cac769e7cace5843b47382bc28cb754e29c894914a75608549ba4843d3c58464077f6a7181cd92723aa2de367df3fc96e9d89966639e01b16b96400a685671e0805aaa90ceaa01a5e6dd0b312cb83bb2906d3da9ad0b5da7d04bcdfe45d1987ca87bc5f46437691b6a1fa7e9b6ec8e2e7675493a21c181d80af0c9ab0d128d9272d309b76a78bc14e82ada00ed223bf1525638f6dfddfa236c8491d51d20d64445137334928d69b67e9cadd5d93893d92366bfc43512bccea638c50ffd1fb45d17115d8daa2b9d7dd6007bfc6bd55fc1462077a7c35651ead9f3d5957737c7ae29ec57593509471f96542a9caa3621652705e27ba4807719ee9bde5f836d4a53614f58fadee13cd2fa410f315ab55cd8a16c2b85781ca3004befc17ddeed09820b52661a653dd7b195e8d279dcca3ada14a235226839ebe651cf4865e857b58769813b044dd2377aa9666cbf7d60e55deeb3cb04291d216129d1a8a80a52c01f07dc9055c2227bed1c2f8242a7323bf2ad7376838f81bbd3f2d8bcbab0c273ff3ceb3648e7339e7b7814ff37a2d1cb4eeffcc7595ace66221c31011175d4a9bac14e9723cf7e2787c51b5a6d190d9724a740e6e010c2e1546e2acb6c602c53aef163f44a9803915b3180c4ed1234b6de1ea84d137aa4a9880f9230db2d1b5dd38b7e2412c6b0d2b870d7c260c3540497aa42eae85eff20d2e817388a40553d27a25eeed467e7a81a5b2450a25f2487ec08c50114d925129a2711b58da381d8e613ddc9bf688034836ce313dd890b768488afd7880145c285d45fcc941f3f5d696b2fdac801a1b37b9123a925582bffb6f69a47a239541a2d6c8b71da88c1c6449d2d49211c39ed879b4630c8e581c29f04a99bb8273494f942d102b8b7fa53027b12eadca5f34249c1cf3e4b6e935d7feff382f609634dca0cec9cc1b301021a59bb18dc2dc3fe6ca34e3f78f0fa42b48fe4436a089fa7d0f5d6755d77dec33407e2ed88bed840ffadfe9a5bc98778b37e629ce81b700c538fd51a64968e1efcdd9439a36bf24b5c4c5eaeb281eabc637fa8c3cfa5ece668b59370db3e066299ba9263a361f82319284f68ec83639c1b310f06759062128a8c9662700b86541a5f04d0b05d423c37951a2cd00d77b35447ec34839a8f0eafb5834d9cd9c0939818ec2031346ae71917ee8af8acfc09a4d45a164f9b376e4b679e76ad9f31b5363f1e456304f5274ac51f650958657a10ceff4965bb04b971bf6fde50ca3f89ac90fb3cd1545c5b78beafce3044d6edf4a0b2bc38f3b3826f5d7108ea2706e3380e947b56a75723013d055e8299968338b0328860c9ad803119609e72e6a8a99eebc2f6a106b498c09e4758fd2f8ddebed0a40b87c2196ce2d2ff6e2d8e6ac3f65a1ce633fa767cb8604c6998b4f570f25539d762011915672fc6218fe5835c98938fe3e207b3703bd2f15e6e28159ca3da8dce65bbc1bf1e9579f0fdeb21b3f5e8c316b2c0dc2529df12bd0b9e88fbd51603c04873f403d739d363391edc59ee47184e9d5906ae0d85ac547bde73f6a133f4a693e286d2afe1384f3c95605cf2ae8ebb3274d6560c9950e8e1a30ffb0f6544a65041c0ff829b5b49b520d9639b5a9b2ba80d13f76547bf2444a600410c3e66feebefa379c3c9389b622bd76961c383ab0a8ec9d2f55ff618bfc390beb03944e085ac5d298328bc343d6df89ad3723dc47e9fe64cd3c01aa9338e7c23f92c4ea5720c8760de9123fc04de10b230498c2350ffc2e71498951ea8f52544dc6da108b0a05caf007ff80dbd0ccf42bf8e6a4be94197b04d400c52191c6ab59b49182fd101bef20af6b886b782fb4974c854a3e3fe8a974802efc1e0a8939aacf0213b718859fba6567e00ed876dd712c7a9b1edbfccc267d491cc75132d48212df00ed05c4ef3724f9b47f4dd2862283a7aa3d1df89b8bca4caa454e416b82f4bf21edea36cbddeca4e365fb429c15b2529df1d3cad9b29954a57d5df20d8f192a9b0639d6cfe795cb774228329ad61781efd07cd5af4bd58d5b190a64827f24671198d28ca39e746098e0d4b9aafd7f48d6b9e74897b797a7790d352aff087c691bb865bdac83be19b537229cb5f8497916550e277482d0f0b13e2a89d2655082c1ab7a32faa62b9e1880c10db8c5c51f610e589e076a25dcf1a39ad43da458484a7d1ef114bd7e307322aabaa4a5b76f301a979057ec6ac030fa51365d1e9773576e8ac6b3a7b6a49325197aa10d7a1df9f89d55b720b4b2b6a34e67662efbe6baec9326199aed7457c66251793ed5ef6005a0264339641322d60e2ea2ecf7c88dcc3f1fd829b4e454c460290d670a4770a803b378fbabd8fd426b2beb9ae50144bce4bdbf61acba3198e999850c02e03ef0f81d4d7c02b8c5d8d9528fad9a635aedb82886b78dfb9838b1a5986444b0e32c34fbd5d42b16b924057d1d86462c16b0e2d387d9e81a167663f9cec6f4a88e5a0ab86c87bd722cf07e0940a0c0a5a70b297771500169da442e758be2134347fdd1e6d69570c430f1338cbc4da9fd4acd24d2c7969123b2f9e6d456cfef28ffeac0a92f3286d9c57c97ab7e87e2cefa306a97f6acd673427fb6e5a36a82278f685b63d699e1911f703dbc9326b85644e4d5168e1dfbfe9efa475349a22c979b63dc595f09e87cf3c109864346759060a3a7357479e8193ec4b987457a74af941b6a2b31d3a924aa01cbd0d7405100559ff642aac0f8677958201557d978a1672748cb8dd41d743c863d99383aef5e9cd8df0a935759ed5d0b428f86a99374f86622020aaa0f208b0f8218ce71ba5f5a2626b26df1e6fbe0b57b749d6bb0c7a97a2f2d116ee494fe133e875e1b8f671293d171c5af0d7eef84362438367711a3f9b6f06860f89aeba0336b36f4dfaa6c5f1aba02a6693e53843e1dd537dce2b29e4c690462cd1ac7cde757349bfc9e96b2105349c23bfbafaad45ed30d37d754297fb4bab873a1ec936e9687dc184c2f528910d65da64e69586aad38cc64257135d6a8a72af961ed94c3ea5558b4c82da77b358added0e34a58b51c4c068df8d7092562493039d6606416c1e047d691b0575022ceae7d2fa8f23a10e5538a514febd4288a19f294cb4c718b9ebe519f86ea4a23fcfcd163ebc9543bb52c658518a10b6d6dd4ddaa49e9080e2be720feb18aeb9500d5e03afa42e662193ea0920dca6db671ea313a702692070490955e14223bd00aec0d645cdd693e5e99d74d12e24c8820127f892d66b8b7cf62a504c0ecd15156c650bbfa10881ea818a312be042f247593b0cf6e578dc076e4dbb426efc468410802670b399de756124bb45b5188cf893ed9d61f057dd0e08d8b8db83559257d4f30b2fdcdb7a4faf7e2aae7400b1def6557d38f3c84f616f0e2cdb4f2066893a539af21fd1b6e38c0c81a79a5170a92a696124383dab0cea111f92288c5d95742c8febfca8e33fce553f2c6a72da8e1483038ea9b999203812fd83f4e4ad82bd9f41ea3d8c8405f15a1b597e7e8e91b4e10ae717ae8e1073e0b2256e74d0d611fbf891ef97588d8d6db4511862a3adb56af7b2fe39d096ee0e3ff64ab2c99062f14303f6783c4b8312447c5bf600d455455f6e5c37d151c03a8d54257b180e74db4a59ce8a3b03fe4a673fd41c65a3f947c2dc97498fb4904418f66e6d9beafd7a2ac0291a954126478eb5c6066052787ead8fb914925aa1a18291e48037e1bffc56175a734ffa85734873beb613153d0d3f8a57f10cc2209be2221cd19410afad498be78d18bc2b622d0ede1a6e23fe7f314bbbf57a1ac230ceb9eefe385632bf07aa038f6f890d51be14af531feef845378cacab0583ab8cf9fba098f08a14bbfa14da0d51c696e8c6461b9c3c8305885f7ded324ce3e3b9cdbc4373fb084730c62286a37da081a060fab59b811e198813ccfc126aa6e236d17c5d2d92be91b9b1be344ca85fe5b22171642af28b053fb42d5735cd2f6aad9918739f6127a917dcae504b6d32253aa927840239d9c5e12f99bfe16705ad0518f7ed34b6b9630b88d3514770bd64e6f593853669e4890f984d48f6feefcf8aecd297200")
	out0, _ := hex.DecodeString("450005dc36d440004006a822ac10ff02ac10ff01a678145192d5000019e81700801801f6619c00000101080ac769e7cac769e7cace5843b47382bc28cb754e29c894914a75608549ba4843d3c58464077f6a7181cd92723aa2de367df3fc96e9d89966639e01b16b96400a685671e0805aaa90ceaa01a5e6dd0b312cb83bb2906d3da9ad0b5da7d04bcdfe45d1987ca87bc5f46437691b6a1fa7e9b6ec8e2e7675493a21c181d80af0c9ab0d128d9272d309b76a78bc14e82ada00ed223bf1525638f6dfddfa236c8491d51d20d64445137334928d69b67e9cadd5d93893d92366bfc43512bccea638c50ffd1fb45d17115d8daa2b9d7dd6007bfc6bd55fc1462077a7c35651ead9f3d5957737c7ae29ec57593509471f96542a9caa3621652705e27ba4807719ee9bde5f836d4a53614f58fadee13cd2fa410f315ab55cd8a16c2b85781ca3004befc17ddeed09820b52661a653dd7b195e8d279dcca3ada14a235226839ebe651cf4865e857b58769813b044dd2377aa9666cbf7d60e55deeb3cb04291d216129d1a8a80a52c01f07dc9055c2227bed1c2f8242a7323bf2ad7376838f81bbd3f2d8bcbab0c273ff3ceb3648e7339e7b7814ff37a2d1cb4eeffcc7595ace66221c31011175d4a9bac14e9723cf7e2787c51b5a6d190d9724a740e6e010c2e1546e2acb6c602c53aef163f44a9803915b3180c4ed1234b6de1ea84d137aa4a9880f9230db2d1b5dd38b7e2412c6b0d2b870d7c260c3540497aa42eae85eff20d2e817388a40553d27a25eeed467e7a81a5b2450a25f2487ec08c50114d925129a2711b58da381d8e613ddc9bf688034836ce313dd890b768488afd7880145c285d45fcc941f3f5d696b2fdac801a1b37b9123a925582bffb6f69a47a239541a2d6c8b71da88c1c6449d2d49211c39ed879b4630c8e581c29f04a99bb8273494f942d102b8b7fa53027b12eadca5f34249c1cf3e4b6e935d7feff382f609634dca0cec9cc1b301021a59bb18dc2dc3fe6ca34e3f78f0fa42b48fe4436a089fa7d0f5d6755d77dec33407e2ed88bed840ffadfe9a5bc98778b37e629ce81b700c538fd51a64968e1efcdd9439a36bf24b5c4c5eaeb281eabc637fa8c3cfa5ece668b59370db3e066299ba9263a361f82319284f68ec83639c1b310f06759062128a8c9662700b86541a5f04d0b05d423c37951a2cd00d77b35447ec34839a8f0eafb5834d9cd9c0939818ec2031346ae71917ee8af8acfc09a4d45a164f9b376e4b679e76ad9f31b5363f1e456304f5274ac51f650958657a10ceff4965bb04b971bf6fde50ca3f89ac90fb3cd1545c5b78beafce3044d6edf4a0b2bc38f3b3826f5d7108ea2706e3380e947b56a75723013d055e8299968338b0328860c9ad803119609e72e6a8a99eebc2f6a106b498c09e4758fd2f8ddebed0a40b87c2196ce2d2ff6e2d8e6ac3f65a1ce633fa767cb8604c6998b4f570f25539d762011915672fc6218fe5835c98938fe3e207b3703bd2f15e6e28159ca3da8dce65bbc1bf1e9579f0fdeb21b3f5e8c316b2c0dc2529df12bd0b9e88fbd51603c04873f403d739d363391edc59ee47184e9d5906ae0d85ac547bde73f6a133f4a693e286d2afe1384f3c95605cf2ae8ebb3274d6560c9950e8e1a30ffb0f6544a65041c0ff829b5b49b520d9639b5a9b2ba80d13f76547bf2444a600410c3e66feebefa379c3c9389b622bd76961c383ab0a8ec9d2f55ff618bfc390beb03944e085ac5d298328bc343d6df89ad3723dc47e9fe64cd3c01aa9338e7c23f92c4ea5720c8760de9123fc04de10b230498c2350ffc2e71498951ea8f52544dc6da108b0a05caf007ff80dbd0ccf42bf8e6a4be94197b04d400c52191c6ab59b49182fd101bef20af6b886b782fb4974c854a3e3fe8a974802efc1e0a8939aacf0213b718859fba6567e00ed876dd712c7a9b1edbfccc267d491cc75132d48212df00ed05c4ef3724f9b47f4dd2862283a7aa3d1df89b8bca4caa454e416b82f4bf21edea36cbddeca4e365fb429c15b2529df1d3cad9b29954a57d5df20d8f192a9b0639d6cfe795cb774228329ad61781efd")
	out1, _ := hex.DecodeString("450005dc36d440004006a822ac10ff02ac10ff01a678145192d5000019e81700801801f6619c00000101080ac769e7cac769e7ca4827f24671198d28ca39e746098e0d4b9aafd7f48d6b9e74897b797a7790d352aff087c691bb865bdac83be19b537229cb5f8497916550e277482d0f0b13e2a89d2655082c1ab7a32faa62b9e1880c10db8c5c51f610e589e076a25dcf1a39ad43da458484a7d1ef114bd7e307322aabaa4a5b76f301a979057ec6ac030fa51365d1e9773576e8ac6b3a7b6a49325197aa10d7a1df9f89d55b720b4b2b6a34e67662efbe6baec9326199aed7457c66251793ed5ef6005a0264339641322d60e2ea2ecf7c88dcc3f1fd829b4e454c460290d670a4770a803b378fbabd8fd426b2beb9ae50144bce4bdbf61acba3198e999850c02e03ef0f81d4d7c02b8c5d8d9528fad9a635aedb82886b78dfb9838b1a5986444b0e32c34fbd5d42b16b924057d1d86462c16b0e2d387d9e81a167663f9cec6f4a88e5a0ab86c87bd722cf07e0940a0c0a5a70b297771500169da442e758be2134347fdd1e6d69570c430f1338cbc4da9fd4acd24d2c7969123b2f9e6d456cfef28ffeac0a92f3286d9c57c97ab7e87e2cefa306a97f6acd673427fb6e5a36a82278f685b63d699e1911f703dbc9326b85644e4d5168e1dfbfe9efa475349a22c979b63dc595f09e87cf3c109864346759060a3a7357479e8193ec4b987457a74af941b6a2b31d3a924aa01cbd0d7405100559ff642aac0f8677958201557d978a1672748cb8dd41d743c863d99383aef5e9cd8df0a935759ed5d0b428f86a99374f86622020aaa0f208b0f8218ce71ba5f5a2626b26df1e6fbe0b57b749d6bb0c7a97a2f2d116ee494fe133e875e1b8f671293d171c5af0d7eef84362438367711a3f9b6f06860f89aeba0336b36f4dfaa6c5f1aba02a6693e53843e1dd537dce2b29e4c690462cd1ac7cde757349bfc9e96b2105349c23bfbafaad45ed30d37d754297fb4bab873a1ec936e9687dc184c2f528910d65da64e69586aad38cc64257135d6a8a72af961ed94c3ea5558b4c82da77b358added0e34a58b51c4c068df8d7092562493039d6606416c1e047d691b0575022ceae7d2fa8f23a10e5538a514febd4288a19f294cb4c718b9ebe519f86ea4a23fcfcd163ebc9543bb52c658518a10b6d6dd4ddaa49e9080e2be720feb18aeb9500d5e03afa42e662193ea0920dca6db671ea313a702692070490955e14223bd00aec0d645cdd693e5e99d74d12e24c8820127f892d66b8b7cf62a504c0ecd15156c650bbfa10881ea818a312be042f247593b0cf6e578dc076e4dbb426efc468410802670b399de756124bb45b5188cf893ed9d61f057dd0e08d8b8db83559257d4f30b2fdcdb7a4faf7e2aae7400b1def6557d38f3c84f616f0e2cdb4f2066893a539af21fd1b6e38c0c81a79a5170a92a696124383dab0cea111f92288c5d95742c8febfca8e33fce553f2c6a72da8e1483038ea9b999203812fd83f4e4ad82bd9f41ea3d8c8405f15a1b597e7e8e91b4e10ae717ae8e1073e0b2256e74d0d611fbf891ef97588d8d6db4511862a3adb56af7b2fe39d096ee0e3ff64ab2c99062f14303f6783c4b8312447c5bf600d455455f6e5c37d151c03a8d54257b180e74db4a59ce8a3b03fe4a673fd41c65a3f947c2dc97498fb4904418f66e6d9beafd7a2ac0291a954126478eb5c6066052787ead8fb914925aa1a18291e48037e1bffc56175a734ffa85734873beb613153d0d3f8a57f10cc2209be2221cd19410afad498be78d18bc2b622d0ede1a6e23fe7f314bbbf57a1ac230ceb9eefe385632bf07aa038f6f890d51be14af531feef845378cacab0583ab8cf9fba098f08a14bbfa14da0d51c696e8c6461b9c3c8305885f7ded324ce3e3b9cdbc4373fb084730c62286a37da081a060fab59b811e198813ccfc126aa6e236d17c5d2d92be91b9b1be344ca85fe5b22171642af28b053fb42d5735cd2f6aad9918739f6127a917dcae504b6d32253aa927840239d9c5e12f99bfe16705ad0518f7ed34b6b9630b88d3514770bd64e6f593853669e4890f984d4")

	f, err := os.Create("handle.pcapng")
	if err != nil {
		t.Fatalf("error creating pcap: %v", err)
	}
	defer f.Close()

	w, err := pcapgo.NewNgWriter(f, layers.LinkTypeIPv4)
	if err != nil {
		t.Fatalf("error constructing writer: %v", err)
	}
	defer w.Flush()

	for i, b := range [][]byte{in, out0, out1} {
		err = w.WritePacket(gopacket.CaptureInfo{
			CaptureLength: len(b),
			Length:        len(b),
		}, b)
		if err != nil {
			t.Fatalf("error writing data for packet %d: %v", i, err)
		}
	}

	type fields struct {
		reader   *bytes.Reader
		tunAddr  netip.Prefix
		tunRoute netip.Prefix
		mode     tsoMode
	}
	type args struct {
		in  []byte
		out [][]byte
	}
	tests := []struct {
		name   string
		fields fields
		args   args
		want   []int
		want1  bool
	}{
		// TODO: Add test cases.
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			p := &packetHandler{
				reader:   tt.fields.reader,
				tunAddr:  tt.fields.tunAddr,
				tunRoute: tt.fields.tunRoute,
				mode:     tt.fields.mode,
			}
			got, got1 := p.handle(tt.args.in, tt.args.out)
			if !reflect.DeepEqual(got, tt.want) {
				t.Errorf("handle() got = %v, want %v", got, tt.want)
			}
			if got1 != tt.want1 {
				t.Errorf("handle() got1 = %v, want %v", got1, tt.want1)
			}
		})
	}
}
